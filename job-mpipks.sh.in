#!/bin/bash -i
#$ -S /bin/bash
#$ -cwd
#$ -N isg
#$ -j y

set -x  # echo commands

project_dir="/home/wittmann/isg"

# For faster disk access copy files to /scratch first.
scratch="/scratch/$USER/$$"
mkdir -p $scratch
cp -r $project_dir/* $scratch

num_temps=$(wc -l < $tempset)
cp $tempset "$scratch/temps.txt"

# Compile
cd $scratch
NUM_REPLICAS=$num_temps ./setup.sh
make

# Generate samples
seeds=$(python dilute.py $N $Z $sigma -n $num_cores)

# Run
# Don't read or write to /home from here
mpirun ./isg -w $dec_warmup -d $dec_max -t "temps.txt" $seeds

# Copy output to home directory, clean up.
bzip2 -9 *.txt
cp *.bz2 $output_dir
cp *.h $output_dir
cd
rm -rf $scratch

